LOAD "testlib.lgo

TO BITFITTEST.SMOKETEST

    ; draw something on the screen
    CLEARSCREEN
    HIDETURTLE
    REPEAT 500 [ FORWARD REPCOUNT RIGHT 91 SETPENCOLOR REPCOUNT ]
    PENUP HOME PENDOWN
    SHOWTURTLE

    ; save the well-known image into bitindex 1 and bitindex 2
    TRACEINSTRUCTION [ SETBITINDEX 1 ]
    TRACEINSTRUCTION [ BITCOPY 200 200 ]

    TRACEINSTRUCTION [ SETBITINDEX 2 ]
    TRACEINSTRUCTION [ BITCOPY 200 200 ]

    ; wipe the screen again
    CLEARSCREEN

    ; scale the image down
    TRACEINSTRUCTION [ SETBITINDEX 1  ]
    TRACEINSTRUCTION [ BITFIT 200 400 ]
    SIMPLEREPORTTEST [ BITSIZE ] [ 200 400 ]
    TRACEINSTRUCTION [ BITPASTE       ]

    ; make sure that the correct image was drawn
    CHECKSCREEN "bitfit-200x400

    ; scale the image down
    CLEARSCREEN
    TRACEINSTRUCTION [ SETBITINDEX 2 ]
    TRACEINSTRUCTION [ BITFIT 100 50 ]
    SIMPLEREPORTTEST [ BITSIZE ] [ 100 50 ]
    TRACEINSTRUCTION [ BITPASTE      ]

    ; make sure that the correct image was drawn
    CHECKSCREEN "bitfit-100x50

END

TO BITFITTEST.BADINPUT

    ; initialize bitindex 1 and fill it with bitmap of a known size
    TRACEINSTRUCTION [ SETBITINDEX 1  ]
    TRACEINSTRUCTION [ BITCUT 200 300 ]

    RUNNOTENOUGHINPUTSTEST [ (BITFIT 100)              ]
    RUNTOOMANYINPUTSTEST   [ (BITFIT 100 100 "toomany) ]

    RUNOUTOFMEMORYTEST     [ BITFIT 2000000000 100 ]  ; allocation failure
    RUNOUTOFMEMORYTEST     [ BITFIT 100 2000000000 ]  ; allocation failure

    ; bad first input
    RUNDOESNTLIKEINPUTTEST [ BITFIT  -1  100 ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT  0   100 ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 1.5  100 ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT [1]  100 ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT {1}  100 ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 1e20 100 ]

    ; bad second input
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100  -1  ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100  0   ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100 1.5  ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100 [1]  ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100 {1}  ]
    RUNDOESNTLIKEINPUTTEST [ BITFIT 100 1e20 ]

    ; the above instructions should not have affected the size of the bitmap
    SIMPLEREPORTTEST [ BITSIZE ] [ 200 300 ]

END

TO BITFITTEST
  BITFITTEST.SMOKETEST
  BITFITTEST.BADINPUT
END

